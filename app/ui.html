<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EtherCAT Motor Control</title>
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-panel: #161b22;
            --bg-card: #21262d;
            --border-ui: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --text-gold: #d29922;
            --accent-purple: #a371f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-panel);
            border: 1px solid var(--border-ui);
            border-radius: 8px;
        }

        .header h1 {
            color: var(--accent-blue);
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .header .status {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-dot.disconnected { background: var(--accent-red); }
        .status-dot.connected { background: var(--text-gold); }
        .status-dot.enabled { background: var(--accent-green); }
        .status-dot.moving { background: var(--accent-blue); animation: pulse 0.5s infinite; }
        .status-dot.fault { background: var(--accent-red); animation: pulse-fast 0.3s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        @keyframes pulse-fast {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .container {
            display: grid;
            grid-template-columns: 280px 1fr 300px;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border-ui);
            border-radius: 8px;
            padding: 20px;
        }

        .panel h2 {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-blue);
            border-bottom: 1px solid var(--border-ui);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .config-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }

        .config-value {
            font-size: 0.7rem;
            color: var(--accent-green);
            word-break: break-all;
            margin-bottom: 15px;
            font-family: monospace;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.85rem;
        }

        .stats-row strong {
            color: var(--accent-blue);
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-ui);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            width: 100%;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: #fff;
        }

        .btn-success {
            background: var(--accent-green);
            color: #fff;
        }

        .btn-danger {
            background: var(--accent-red);
            color: #fff;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-ui);
            color: var(--text-primary);
        }

        .btn-gold {
            background: var(--text-gold);
            color: #000;
        }

        .btn:hover {
            opacity: 0.85;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        hr {
            border: 0;
            border-top: 1px solid var(--border-ui);
            margin: 20px 0;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-ui);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-ui);
        }

        th {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        td {
            font-family: monospace;
        }

        .td-status {
            width: 30px;
        }

        .status-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-icon.enabled { background: var(--accent-green); }
        .status-icon.disabled { background: var(--text-secondary); }
        .status-icon.fault { background: var(--accent-red); }

        .op-row-1 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .op-row-2 {
            display: grid;
            grid-template-columns: 1fr 200px;
            gap: 15px;
        }

        .sequence-list {
            background: var(--bg-card);
            border: 1px solid var(--border-ui);
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .seq-header {
            display: block;
            font-size: 0.8rem;
            color: var(--text-gold);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .seq-item {
            padding: 8px 10px;
            font-size: 0.8rem;
            border-left: 2px solid var(--border-ui);
            margin-bottom: 5px;
            font-family: monospace;
        }

        .seq-item.active {
            border-left-color: var(--accent-green);
            background: rgba(63, 185, 80, 0.1);
        }

        .seq-item.completed {
            border-left-color: var(--accent-blue);
            color: var(--text-secondary);
        }

        #log-window {
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.75rem;
            background: var(--bg-card);
            border-radius: 6px;
            padding: 10px;
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(48, 54, 61, 0.5);
        }

        .log-ts {
            color: var(--text-secondary);
            margin-right: 8px;
        }

        .log-sys { color: var(--accent-green); }
        .log-com { color: var(--accent-blue); }
        .log-wrn { color: var(--text-gold); }
        .log-err { color: var(--accent-red); }

        .quick-move-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .quick-move-grid button {
            padding: 12px 8px;
            font-size: 0.8rem;
        }

        .btn-home {
            background: var(--accent-purple);
            color: #fff;
            grid-column: span 2;
        }

        .velocity-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .velocity-control label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .velocity-control input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            background: var(--bg-card);
            height: 6px;
            border-radius: 3px;
        }

        .velocity-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent-blue);
            border-radius: 50%;
            cursor: pointer;
        }

        .ws-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .header-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .ui-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.8rem;
        }

        .ui-toggle label {
            color: var(--text-secondary);
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-card);
            border: 1px solid var(--border-ui);
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: var(--text-secondary);
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
            background-color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-wrapper">
            <div class="header-left">
                <h1>EtherCAT Motor Control System</h1>
                <div class="status">
                    <span>
                        <span class="status-dot disconnected" id="statusDot"></span>
                        <span id="statusText">Disconnected</span>
                    </span>
                    <span class="ws-indicator">
                        <span class="status-dot disconnected" id="wsDot"></span>
                        WebSocket
                    </span>
                </div>
            </div>
            <div class="ui-toggle">
                <label>Classic UI</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="uiToggle" onchange="toggleUI()">
                    <span class="toggle-slider"></span>
                </label>
                <label>New UI</label>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Left Panel: System Config -->
        <aside class="panel">
            <h2>System Config</h2>
            
            <div class="config-label">Interface:</div>
            <div class="config-value" id="interfaceDisplay">Not connected</div>
            
            <div class="stats-row">
                <span>Slaves: <strong id="slaveCount">0</strong></span>
                <span>Mode: <strong id="modeLabel">--</strong></span>
            </div>

            <select id="modeSelector" onchange="changeMode()">
                <option value="8">CSP (Cyclic Sync Position)</option>
                <option value="1">PP (Profile Position)</option>
                <option value="3">PV (Profile Velocity)</option>
            </select>

            <hr>

            <button class="btn btn-outline" onclick="sendCmd('reset')" style="margin-bottom:10px">Reset Fault</button>
            <button class="btn btn-danger" onclick="sendCmd('disable')" style="margin-bottom:10px">Disable Slaves</button>
            <button class="btn btn-success" onclick="sendCmd('enable')" id="enableBtn">Enable Slaves</button>

            <hr>

            <div class="config-label">Set Home for Slave:</div>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <select id="homeSlaveSelect" style="flex: 1; margin: 0;" onchange="updateButtonStates()">
                    <option value="" disabled selected>-- Select Slave --</option>
                </select>
                <button class="btn btn-gold" onclick="setHome()" style="width: auto; padding: 10px 15px;" id="setHomeBtn" disabled>Set Home</button>
            </div>
            <button class="btn btn-gold" onclick="setHomeAll()" style="margin-bottom: 15px;" id="setHomeAllBtn">Set Home All Slaves</button>

            <hr>

            <div class="config-label">Clear Error for Slave:</div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <select id="clearErrorSlaveSelect" style="flex: 1; margin: 0;" onchange="updateButtonStates()">
                    <option value="" disabled selected>-- Select Slave --</option>
                </select>
                <button class="btn btn-danger" onclick="clearError()" style="width: auto; padding: 10px 15px;" id="clearErrorBtn" disabled>Clear Err</button>
            </div>

            <hr>

            <button class="btn" onclick="terminateProgram()" style="background: #8B0000; margin-top: 10px;" id="terminateBtn">‚èª Terminate Program</button>

            <hr>

            <!-- PP Mode Speed -->
            <div id="speedPP">
                <h2 style="margin-top: 0; color: var(--accent-green);">PP Speed</h2>

                <div class="config-label">Speed (x1000 units/s):</div>
                <input type="number" id="ppSpeed" value="80" style="margin-bottom: 8px;" oninput="updatePPEffective()">

                <div class="config-label" style="font-size: 0.7rem; color: var(--text-secondary);">
                    Velocity: <span id="ppEffectiveVel">80000</span> units/s |
                    Accel/Decel: <span id="ppEffectiveAccel">40000</span> units/s¬≤
                </div>

                <button class="btn btn-success" onclick="applyPPSpeed()" style="margin-top: 10px;">Apply PP Speed</button>
            </div>

            <!-- CSP Mode Speed -->
            <div id="speedCSP" style="display: none;">
                <h2 style="margin-top: 0; color: var(--accent-blue);">CSP Speed</h2>

                <div class="config-label">Max Step (units/ms):</div>
                <input type="number" id="cspMaxStep" value="800" style="margin-bottom: 8px;" oninput="updateCSPEffective()">

                <div class="config-label">Effective Velocity: <span id="cspEffectiveVel">800000</span> units/s</div>

                <button class="btn btn-primary" onclick="applyCSPSpeed()" style="margin-top: 10px;">Apply CSP Speed</button>
            </div>

            <!-- PV Mode Speed -->
            <div id="speedPV" style="display: none;">
                <h2 style="margin-top: 0; color: var(--text-gold);">PV Speed</h2>

                <div class="config-label">Speed (x1000 units/s):</div>
                <input type="number" id="pvSpeed" value="50" style="margin-bottom: 8px;" oninput="updatePVEffective()">

                <div class="config-label" style="font-size: 0.7rem; color: var(--text-secondary);">
                    Velocity: <span id="pvEffectiveVel">50000</span> units/s |
                    Accel/Decel: <span id="pvEffectiveAccel">25000</span> units/s¬≤
                </div>

                <button class="btn btn-gold" onclick="applyPVSpeed()" style="margin-top: 10px;">Apply PV Speed</button>
            </div>
        </aside>

        <!-- Main Panel: Operations -->
        <main class="panel">
            <h2>Real-time Operations</h2>
            
            <div class="op-row-1">
                <!-- Position Table -->
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th class="td-status"></th>
                                <th>ID</th>
                                <th>Position (m)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="positionTable">
                            <tr>
                                <td class="td-status"><span class="status-icon disabled"></span></td>
                                <td>#01</td>
                                <td>0.0000</td>
                                <td>--</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Manual Controls -->
                <div class="card" id="manualControls">
                    <!-- Position Mode Controls (PP/CSP) -->
                    <div id="positionControls">
                        <div class="config-label" style="margin-bottom: 10px;">Quick Move:</div>
                        <div class="quick-move-grid">
                            <button class="btn btn-outline" onclick="moveTo(-1.0)">-1.0m</button>
                            <button class="btn btn-outline" onclick="moveTo(-0.5)">-0.5m</button>
                            <button class="btn btn-outline" onclick="moveTo(0.5)">+0.5m</button>
                            <button class="btn btn-outline" onclick="moveTo(1.0)">+1.0m</button>
                            <button class="btn btn-home" onclick="moveTo(0)">HOME (0m)</button>
                            <button class="btn btn-outline" onclick="moveTo(-0.25)">-0.25m</button>
                            <button class="btn btn-outline" onclick="moveTo(0.25)">+0.25m</button>
                        </div>
                        
                        <!-- STOP Button -->
                        <button id="emergencyStopBtn" class="btn btn-danger" onclick="emergencyStop()" style="margin: 15px 0; font-size: 1.2em; padding: 15px; width: 100%;" disabled>
                            ‚ñ™ EMERGENCY STOP
                        </button>
                        
                        <div class="config-label" style="margin-bottom: 10px;">Custom Move:</div>
                        <select id="slaveSelect" style="margin-bottom: 10px;" onchange="updateButtonStates()">
                            <option value="" disabled selected>-- Select Slave --</option>
                        </select>
                        <input type="number" id="targetPosition" placeholder="Target Position (meters)" step="0.01">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px;">
                            <button class="btn btn-primary" onclick="executeMove()">Execute Move</button>
                            <button id="allToHomeBtn" class="btn btn-home" onclick="moveAllToHome()">All to Home</button>
                        </div>
                    </div>
                    
                    <!-- Velocity Mode Controls (PV) -->
                    <div id="velocityControls" style="display: none;">
                        <div class="config-label" style="margin-bottom: 10px;">Velocity Control:</div>
                        <select id="slaveSelectVel" style="margin-bottom: 15px;" onchange="updateButtonStates()">
                            <option value="" disabled selected>-- Select Slave --</option>
                        </select>
                        
                        <button class="btn btn-success" onclick="velocityForward()" style="margin-bottom: 10px; font-size: 1.1em; padding: 15px;">
                            ‚ñ≤ FORWARD
                        </button>
                        <button class="btn btn-danger" onclick="emergencyStop()" style="margin-bottom: 10px; font-size: 1.2em; padding: 20px; background: #dc3545;">
                            ‚ñ™ EMERGENCY STOP
                        </button>
                        <button class="btn btn-primary" onclick="velocityBackward()" style="font-size: 1.1em; padding: 15px;">
                            ‚ñº BACKWARD
                        </button>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 10px;">
                            Speed is set in PV Speed panel on the left
                        </p>
                    </div>
                </div>
            </div>

            <!-- Template Section -->
            <div id="templateSection">
                <h2 style="border-color: var(--text-gold); color: var(--text-gold);">Template Execution</h2>

                <!-- Config file dropdown -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <select id="configFileName" style="flex: 1; margin: 0;">
                        <option value="">-- Select Config --</option>
                    </select>
                    <button class="btn btn-outline" onclick="refreshConfigList()" style="width: auto; padding: 10px 12px;" title="Refresh list">‚Üª</button>
                    <button class="btn btn-primary" onclick="loadConfigFile()" style="width: auto; padding: 10px 15px;">Load</button>
                </div>
                
                <!-- Steps per Meter Config -->
                <div class="card" style="margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
                        <div>
                            <div class="config-label">Actual Steps/m:</div>
                            <input type="number" id="actualStepsInput" value="792914" style="margin: 0;">
                        </div>
                        <div>
                            <div class="config-label">Raw Steps/m:</div>
                            <input type="number" id="rawStepsInput" value="202985985" style="margin: 0;">
                        </div>
                        <button class="btn btn-primary" onclick="applyStepsConfig()" style="height: 38px;">Apply</button>
                    </div>
                </div>
                
                <!-- Config Info -->
                <div id="configInfo" class="card" style="margin-bottom: 15px; display: none;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--text-primary);">Config Info</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem;">
                        <div>
                            <div class="config-label">Operation Mode:</div>
                            <div id="cfgOpMode" style="color: var(--text-gold);">--</div>
                        </div>
                        <div>
                            <div class="config-label">Slave Count:</div>
                            <div id="cfgSlaveCount">--</div>
                        </div>
                        <div>
                            <div class="config-label">Movement Slaves:</div>
                            <div id="cfgMovementSlaves" style="color: var(--accent-green);">--</div>
                        </div>
                        <div>
                            <div class="config-label">Movement Speed:</div>
                            <div id="cfgMovementSpeed">--</div>
                        </div>
                        <div>
                            <div class="config-label">Rotation Slaves:</div>
                            <div id="cfgRotationSlaves" style="color: var(--accent-blue);">--</div>
                        </div>
                        <div>
                            <div class="config-label">Rotation Speed:</div>
                            <div id="cfgRotationSpeed">--</div>
                        </div>
                        <div style="grid-column: span 2;">
                            <div class="config-label">Movement Mode:</div>
                            <div id="cfgMovementMode" style="color: var(--accent-green);">--</div>
                        </div>
                    </div>
                </div>
                
                <!-- Template Steps Table -->
                <div class="card" style="margin-bottom: 15px; overflow-x: auto;">
                    <div id="templateName" style="font-weight: bold; margin-bottom: 10px; color: var(--text-gold);">No template loaded</div>
                    <table id="templateTable" style="width: 100%; font-size: 0.8rem;">
                        <thead>
                            <tr>
                                <th style="width: 40px;">#</th>
                                <th>Name</th>
                                <th style="width: 80px;">Type</th>
                                <th>Position</th>
                                <th style="width: 60px;">Delay</th>
                                <th style="width: 80px;">Time</th>
                                <th style="width: 100px;">Order</th>
                            </tr>
                        </thead>
                        <tbody id="templateTableBody">
                            <tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">Load a config file to see steps</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Run buttons -->
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="btn btn-success" onclick="runTemplate()" style="flex:1">‚ñ∂ Run Template</button>
                    <button class="btn btn-primary" onclick="runTemplateLoop()" style="flex:1">üîÑ Loop Template</button>
                </div>
                <button class="btn btn-danger" onclick="emergencyStop()" style="width: 100%; font-size: 1.1em; padding: 15px;">
                    ‚ñ† STOP
                </button>
            </div>

            <!-- OSC Section (PP mode only) -->
            <div id="oscSection" style="margin-top: 20px; display: none;">
                <h2 style="border-color: var(--text-gold); color: var(--text-gold);">OSC Control</h2>

                <div class="card">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span class="status-dot disconnected" id="oscStatusDot"></span>
                        <span id="oscStatusText" style="font-size: 0.85rem;">Disconnected</span>
                    </div>

                    <!-- Connection Info (shown when connected) -->
                    <div id="oscConnectionInfo" style="display: none; margin-bottom: 10px; padding: 8px; background: var(--bg-dark); border-radius: 4px; font-size: 0.75rem;">
                        <div id="oscRecvInfo" style="color: var(--accent-blue); margin-bottom: 3px;"></div>
                        <div id="oscSendInfo" style="color: var(--accent-green);"></div>
                    </div>

                    <!-- OSC Mode Selection -->
                    <div class="config-label" style="margin-bottom: 5px;">Mode:</div>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px; font-size: 0.8rem; cursor: pointer;">
                            <input type="radio" name="oscMode" value="1" style="margin: 0; width: auto;">
                            <span>Receive</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; font-size: 0.8rem; cursor: pointer;">
                            <input type="radio" name="oscMode" value="2" style="margin: 0; width: auto;">
                            <span>Send</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; font-size: 0.8rem; cursor: pointer;">
                            <input type="radio" name="oscMode" value="3" checked style="margin: 0; width: auto;">
                            <span>Both</span>
                        </label>
                    </div>

                    <!-- Receiver Settings -->
                    <div style="background: var(--bg-dark); padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                        <div class="config-label" style="color: var(--accent-blue); margin-bottom: 8px;">Receiver (Listen on):</div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                            <div>
                                <div class="config-label">IP:</div>
                                <input type="text" id="oscRecvIp" value="0.0.0.0" placeholder="0.0.0.0" style="margin: 0;">
                            </div>
                            <div>
                                <div class="config-label">Port:</div>
                                <input type="number" id="oscRecvPort" value="8001" placeholder="8001" style="margin: 0;">
                            </div>
                        </div>
                    </div>

                    <!-- Sender Settings -->
                    <div style="background: var(--bg-dark); padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                        <div class="config-label" style="color: var(--accent-green); margin-bottom: 8px;">Sender (Send to):</div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                            <div>
                                <div class="config-label">IP:</div>
                                <input type="text" id="oscSendIp" value="127.0.0.1" placeholder="127.0.0.1" style="margin: 0;">
                            </div>
                            <div>
                                <div class="config-label">Port:</div>
                                <input type="number" id="oscSendPort" value="9000" placeholder="9000" style="margin: 0;">
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="oscConnect()" id="oscConnectBtn" style="flex: 1;">Start OSC</button>
                        <button class="btn btn-danger" onclick="oscDisconnect()" id="oscDisconnectBtn" style="flex: 1;" disabled>Stop OSC</button>
                    </div>

                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 10px;">
                        <div style="margin-bottom: 5px;"><strong>Sends:</strong></div>
                        <div>/slave_move/&lt;slave_id&gt;/&lt;position&gt;</div>
                        <div>/template_step/&lt;step_no&gt;</div>
                        <div>/template_complete</div>
                        <div style="margin-top: 5px;"><strong>Receives:</strong></div>
                        <div>/slave_move/&lt;id&gt; &lt;float&gt; - Move slave</div>
                        <div>/template_run - Run template</div>
                        <div>/template_stop - Stop template</div>
                        <div>/enable, /disable, /reset</div>
                    </div>
                </div>

                <!-- OSC Log Display -->
                <div class="card" style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: bold; color: var(--text-gold);">OSC Log</span>
                        <button class="btn btn-outline" onclick="clearOscLog()" style="width: auto; padding: 5px 10px; font-size: 0.7rem;">Clear</button>
                    </div>
                    <div id="osc-log-window" style="height: 150px; overflow-y: auto; background: var(--bg-dark); border: 1px solid var(--border-ui); border-radius: 4px; padding: 8px; font-family: monospace; font-size: 0.75rem;"></div>
                </div>
            </div>

            <!-- UDP Receiver Section (CSP mode only) -->
            <div id="udpSection" style="margin-top: 20px; display: none;">
                <h2 style="border-color: var(--accent-purple); color: var(--accent-purple);">UDP Receiver</h2>

                <div class="card">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span class="status-dot disconnected" id="udpStatusDot"></span>
                        <span id="udpStatusText" style="font-size: 0.85rem;">Disconnected</span>
                    </div>

                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <div class="config-label">IP Address:</div>
                            <input type="text" id="udpIp" value="0.0.0.0" placeholder="0.0.0.0" style="margin: 0;">
                        </div>
                        <div>
                            <div class="config-label">Port:</div>
                            <input type="number" id="udpPort" value="9000" placeholder="9000" style="margin: 0;">
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="udpConnect()" id="udpConnectBtn" style="flex: 1;">Connect</button>
                        <button class="btn btn-danger" onclick="udpDisconnect()" id="udpDisconnectBtn" style="flex: 1;" disabled>Disconnect</button>
                    </div>

                    <p style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 10px;">
                        Format: slave,pos or slave1,pos1;slave2,pos2<br>
                        Example: 0,-0.10;1,0.20
                    </p>
                </div>

                <!-- UDP Log Display -->
                <div class="card" style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: bold; color: var(--accent-purple);">UDP Log</span>
                        <button class="btn btn-outline" onclick="clearUdpLog()" style="width: auto; padding: 5px 10px; font-size: 0.7rem;">Clear</button>
                    </div>
                    <div id="udp-log-window" style="height: 150px; overflow-y: auto; background: var(--bg-dark); border: 1px solid var(--border-ui); border-radius: 4px; padding: 8px; font-family: monospace; font-size: 0.75rem;"></div>
                </div>
            </div>
        </main>

        <!-- Right Panel: Logs -->
        <aside class="panel">
            <h2>System Logs</h2>
            <div id="log-window"></div>
            <button class="btn btn-outline" onclick="clearLogs()" style="margin-top: 10px;">Clear Logs</button>
            
            <!-- Template Execution Log -->
            <h2 style="margin-top: 20px; border-color: var(--text-gold); color: var(--text-gold);">Template Log</h2>
            <div id="template-log-window" style="height: 200px; overflow-y: auto; background: var(--bg-card); border: 1px solid var(--border-ui); border-radius: 4px; padding: 10px; font-family: monospace; font-size: 0.8rem;"></div>
            <button class="btn btn-outline" onclick="clearTemplateLogs()" style="margin-top: 10px;">Clear Template Log</button>

            <!-- Move Order Log -->
            <h2 style="margin-top: 20px; border-color: var(--accent-blue); color: var(--accent-blue);">Move Order Log</h2>
            <div id="move-order-log-window" style="height: 180px; overflow-y: auto; background: var(--bg-card); border: 1px solid var(--border-ui); border-radius: 4px; padding: 10px; font-family: monospace; font-size: 0.75rem; white-space: pre-wrap;"></div>
            <button class="btn btn-outline" onclick="clearMoveOrderLog()" style="margin-top: 10px;">Clear Move Order Log</button>
        </aside>
    </div>

    <script>
        let ws = null;
        let reconnectTimer = null;
        let isTerminating = false;  // Flag to prevent reconnection after terminate

        // Toggle UI version
        function toggleUI() {
            const isNewUI = document.getElementById('uiToggle').checked;
            if (isNewUI) {
                // Redirect to new UI
                window.location.href = 'newui.html';
            }
        }

        // Connect WebSocket
        function connectWS() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            try {
                ws = new WebSocket(wsUrl);
            } catch (e) {
                log('WebSocket creation failed', 'err');
                return;
            }
            
            ws.onopen = () => {
                document.getElementById('wsDot').className = 'status-dot enabled';
                log('WebSocket connected', 'sys');
                window.wsRetryCount = 0;  // Reset retry counter
                if (reconnectTimer) {
                    clearInterval(reconnectTimer);
                    reconnectTimer = null;
                }
                // Auto-load config files list
                setTimeout(() => {
                    refreshConfigList();
                }, 500);
            };
            
            ws.onclose = (event) => {
                document.getElementById('wsDot').className = 'status-dot disconnected';

                // Don't try to reconnect if we're terminating
                if (isTerminating) {
                    log('Program terminated - connection closed', 'sys');
                    return;
                }

                log(`WebSocket disconnected (code: ${event.code})`, 'wrn');
                if (!reconnectTimer) {
                    window.wsRetryCount = (window.wsRetryCount || 0) + 1;
                    const retryDelay = Math.min(1000 * window.wsRetryCount, 5000);  // 1s, 2s, 3s, max 5s
                    log(`Reconnecting in ${retryDelay/1000}s...`, 'sys');
                    reconnectTimer = setTimeout(() => {
                        reconnectTimer = null;
                        connectWS();
                    }, retryDelay);
                }
            };
            
            ws.onerror = (e) => {
                // Don't log errors if we're terminating
                if (isTerminating) return;
                log('WebSocket error - check server connection', 'err');
            };
            
            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'status') {
                        updateStatus(msg.data);
                    } else if (msg.type === 'response') {
                        handleResponse(msg.data);
                    }
                } catch (e) {
                    console.error('Message parse error:', e);
                }
            };
        }

        // Update UI with status
        function updateStatus(status) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const modeLabel = document.getElementById('modeLabel');
            const slaveCount = document.getElementById('slaveCount');
            const modeSelector = document.getElementById('modeSelector');
            const interfaceDisplay = document.getElementById('interfaceDisplay');
            
            // Check for faults from status_words directly (more reliable)
            const statusWords = status.status_words || [];
            const errorCodes = status.error_codes || [];
            let hasFault = false;
            let faultSlaves = [];
            
            for (let i = 0; i < statusWords.length; i++) {
                if (statusWords[i] & 0x0008) {  // Fault bit
                    hasFault = true;
                    faultSlaves.push(i);
                }
            }
            
            // Update status dot
            dot.className = 'status-dot';
            if (hasFault) {
                dot.classList.add('fault');
                const faultList = faultSlaves.map(s => `#${s+1}`).join(', ');
                text.textContent = `FAULT (Slave ${faultList})`;
                text.style.color = 'var(--accent-red)';
                
                // Show fault alert (only once per fault combination)
                const faultKey = faultSlaves.join(',');
                if (window.lastFaultKey !== faultKey) {
                    window.lastFaultKey = faultKey;
                    log(`‚ö†Ô∏è FAULT detected on slave(s): ${faultList}`, 'err');
                    templateLog(`‚ö†Ô∏è FAULT on slave(s): ${faultList}`, 'error');
                    
                    // Get error details for each faulted slave
                    faultSlaves.forEach(idx => {
                        const errCode = errorCodes[idx] || 0;
                        if (errCode > 0) {
                            const errorInfo = getErrorInfo(errCode);
                            const hexCode = errCode.toString(16).toUpperCase();
                            log(`  Slave #${idx+1}: ${errorInfo.name} (0x${hexCode}) [${errorInfo.display}]`, 'err');
                            templateLog(`  Slave #${idx+1}: ${errorInfo.name} [${errorInfo.display}]`, 'error');
                        }
                    });
                }
            } else {
                window.lastFaultKey = null;  // Reset fault key
                text.style.color = '';

                if (status.state === 0) {
                    dot.classList.add('disconnected');
                    text.textContent = 'Disconnected';
                } else if (status.state === 1) {
                    dot.classList.add('connected');
                    text.textContent = 'Connected';
                } else if (status.state === 2) {
                    dot.classList.add('enabled');
                    text.textContent = 'Enabled';
                }

                if (status.moving) {
                    dot.classList.remove('enabled', 'connected');
                    dot.classList.add('moving');
                    text.textContent += ' (Moving...)';
                }
            }

            // Disable mode selector and enable button when faults are detected
            const enableBtn = document.getElementById('enableBtn');
            const setHomeBtn = document.getElementById('setHomeBtn');
            const setHomeAllBtn = document.getElementById('setHomeAllBtn');
            const clearErrorBtn = document.getElementById('clearErrorBtn');
            const isEnabled = status.state === 2;  // Drives are enabled

            if (hasFault) {
                modeSelector.disabled = true;
                modeSelector.title = 'Clear faults first before changing mode';
                if (enableBtn) {
                    enableBtn.disabled = true;
                    enableBtn.title = 'Clear faults first before enabling';
                }
            } else if (isEnabled) {
                // Drives are enabled - disable mode change
                modeSelector.disabled = true;
                modeSelector.title = 'Disable drives first before changing mode';
                if (enableBtn) {
                    enableBtn.disabled = false;
                    enableBtn.title = '';
                }
            } else {
                modeSelector.disabled = false;
                modeSelector.title = '';
                if (enableBtn) {
                    enableBtn.disabled = false;
                    enableBtn.title = '';
                }
            }

            // Disable Set Home buttons when enabled
            if (setHomeBtn) {
                if (isEnabled) {
                    setHomeBtn.disabled = true;
                    setHomeBtn.title = 'Disable drives first';
                    setHomeBtn.style.opacity = '0.5';
                } else {
                    // Re-enable based on slave selection
                    const homeSlaveSelected = document.getElementById('homeSlaveSelect').value !== '';
                    setHomeBtn.disabled = !homeSlaveSelected;
                    setHomeBtn.title = '';
                    setHomeBtn.style.opacity = homeSlaveSelected ? '1' : '0.5';
                }
            }
            if (setHomeAllBtn) {
                if (isEnabled) {
                    setHomeAllBtn.disabled = true;
                    setHomeAllBtn.title = 'Disable drives first';
                    setHomeAllBtn.style.opacity = '0.5';
                } else {
                    setHomeAllBtn.disabled = false;
                    setHomeAllBtn.title = '';
                    setHomeAllBtn.style.opacity = '1';
                }
            }

            // Disable Clear Error button when enabled
            if (clearErrorBtn) {
                if (isEnabled) {
                    clearErrorBtn.disabled = true;
                    clearErrorBtn.title = 'Disable drives first';
                    clearErrorBtn.style.opacity = '0.5';
                } else {
                    // Re-enable based on slave selection
                    const clearErrorSlaveSelected = document.getElementById('clearErrorSlaveSelect').value !== '';
                    clearErrorBtn.disabled = !clearErrorSlaveSelected;
                    clearErrorBtn.title = '';
                    clearErrorBtn.style.opacity = clearErrorSlaveSelected ? '1' : '0.5';
                }
            }

            // All to Home button - only enabled when drives are enabled and no fault
            const allToHomeBtn = document.getElementById('allToHomeBtn');
            if (allToHomeBtn) {
                const canMoveAllHome = isEnabled && !hasFault;
                allToHomeBtn.disabled = !canMoveAllHome;
                allToHomeBtn.style.opacity = canMoveAllHome ? '1' : '0.5';
                allToHomeBtn.style.cursor = canMoveAllHome ? 'pointer' : 'not-allowed';
                allToHomeBtn.title = hasFault ? 'Clear faults first' : (!isEnabled ? 'Enable drives first' : '');
            }

            // Update mode
            if (status.mode !== undefined) {
                const modeNames = {1: 'PP', 3: 'PV', 8: 'CSP'};
                modeLabel.textContent = modeNames[status.mode] || status.mode;
                modeSelector.value = status.mode.toString();
                updateModeUI(status.mode);
            }
            
            // Update slave count
            const numSlaves = status.num_slaves || status.positions?.length || 0;
            slaveCount.textContent = numSlaves;
            
            // Update interface display
            if (status.interface) {
                interfaceDisplay.textContent = status.interface;
            }
            
            // Update position table
            updatePositionTable(status);

            // Update slave selectors
            updateSlaveSelector(numSlaves);

            // Update UDP status
            if (status.udp_connected !== undefined) {
                updateUdpStatus(status.udp_connected);
            }

            // Update OSC status
            if (status.osc_connected !== undefined) {
                updateOscStatus(status.osc_connected, status.osc_mode || 0, status.osc_ip, status.osc_port);
            }

            // Show/hide UDP section based on mode (only show in CSP mode = 8)
            const udpSection = document.getElementById('udpSection');
            if (udpSection) {
                udpSection.style.display = (status.mode === 8) ? 'block' : 'none';
            }

            // Show/hide OSC section based on mode (only show in PP mode = 1)
            const oscSection = document.getElementById('oscSection');
            if (oscSection) {
                oscSection.style.display = (status.mode === 1) ? 'block' : 'none';
            }

            // Log slave info on first update
            if (numSlaves > 0 && !window.slavesLogged) {
                log(`Connected: ${numSlaves} slave(s) found`, 'sys');
                window.slavesLogged = true;
            }

            // Handle events (slave changes, errors)
            if (status.event && status.event.counter !== window.lastEventCounter) {
                window.lastEventCounter = status.event.counter;
                handleEvent(status.event);
            }
        }

        // Handle system events (slave changes, errors, etc.)
        function handleEvent(event) {
            const eventTypes = {1: 'SLAVE_CHANGE', 2: 'ERROR', 3: 'INFO'};
            const typeName = eventTypes[event.type] || 'UNKNOWN';

            console.log(`[EVENT] ${typeName}:`, event);

            if (event.type === 1) {
                // Slave change event
                showEventAlert('warning', `Slave Connection Changed`, event.message, true);
                log(`‚ö†Ô∏è ${event.message}`, 'wrn');
                templateLog(`‚ö†Ô∏è ${event.message}`, 'warning');
            } else if (event.type === 2) {
                // Error event - check if it's a communication error (Er81b)
                const isCommError = event.code === 0x81B || event.message.includes('Communication');
                const errorMsg = isCommError
                    ? `${event.message}<br><small style="color: var(--text-secondary);">Auto-recovery will be attempted. If it fails, use "Recover" button.</small>`
                    : event.message;
                showEventAlert('error', `Motor Error Detected`, errorMsg, true, isCommError);
                log(`‚ùå ${event.message}`, 'err');
                templateLog(`‚ùå ${event.message}`, 'error');
            } else if (event.type === 3) {
                // Info event (including recovery success)
                if (event.message.includes('recovery') || event.message.includes('Reconnected')) {
                    showEventAlert('info', `Recovery Status`, event.message, false);
                }
                log(`‚ÑπÔ∏è ${event.message}`, 'sys');
            }

            // Clear event after processing
            sendCmd('clear_event');
        }

        // Show event alert modal/banner
        function showEventAlert(type, title, message, showActions, showRecoverBtn = false) {
            // Remove existing alert if any
            const existingAlert = document.getElementById('eventAlert');
            if (existingAlert) {
                existingAlert.remove();
            }

            const colors = {
                'error': 'var(--accent-red)',
                'warning': 'var(--text-gold)',
                'info': 'var(--accent-blue)'
            };

            // Build action buttons based on context
            let actionButtons = '';
            if (showActions) {
                actionButtons = `
                    <div style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                        <button class="btn btn-outline" onclick="dismissEventAlert()" style="padding: 8px 15px;">Dismiss</button>
                        <button class="btn btn-secondary" onclick="handleEventAction('reset')" style="padding: 8px 15px;">Reset Fault</button>
                        ${showRecoverBtn ? `<button class="btn btn-warning" onclick="handleEventAction('recover')" style="padding: 8px 15px; background: var(--text-gold); color: var(--bg-primary);">Recover</button>` : ''}
                        <button class="btn btn-primary" onclick="handleEventAction('rescan')" style="padding: 8px 15px;">Rescan Slaves</button>
                    </div>
                `;
            } else {
                actionButtons = `
                    <div style="display: flex; justify-content: flex-end;">
                        <button class="btn btn-outline" onclick="dismissEventAlert()" style="padding: 8px 15px;">OK</button>
                    </div>
                `;
            }

            const alertHtml = `
                <div id="eventAlert" style="
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: var(--bg-panel);
                    border: 2px solid ${colors[type]};
                    border-radius: 8px;
                    padding: 15px 25px;
                    z-index: 1000;
                    min-width: 350px;
                    max-width: 500px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
                    animation: slideDown 0.3s ease;
                ">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 1.5rem;">${type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
                        <span style="font-weight: bold; color: ${colors[type]}; font-size: 1.1rem;">${title}</span>
                    </div>
                    <div style="color: var(--text-primary); margin-bottom: 15px; font-size: 0.9rem;">
                        ${message}
                    </div>
                    ${actionButtons}
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', alertHtml);

            // Auto-dismiss after 30 seconds if no action
            setTimeout(() => {
                const alert = document.getElementById('eventAlert');
                if (alert) alert.remove();
            }, 30000);
        }

        function dismissEventAlert() {
            const alert = document.getElementById('eventAlert');
            if (alert) alert.remove();
        }

        function handleEventAction(action) {
            dismissEventAlert();
            if (action === 'reset') {
                sendCmd('reset');
                log('Reset fault command sent', 'sys');
            } else if (action === 'rescan') {
                sendCmd('rescan');
                log('Rescan slaves command sent', 'sys');
            } else if (action === 'recover') {
                sendCmd('recover');
                log('Manual recovery command sent - attempting to reconnect...', 'sys');
            }
        }

        // Track currently moving slaves for highlighting
        let currentMovingSlaves = [];
        let currentMoveOrder = [];

        // Update position table
        function updatePositionTable(status) {
            const tbody = document.getElementById('positionTable');
            const positions = status.positions || [];
            const statusWords = status.status_words || [];
            const errorCodes = status.error_codes || [];

            let html = '';
            for (let i = 0; i < positions.length; i++) {
                const pos = positions[i].toFixed(4);
                const sw = statusWords[i] || 0;
                const errorCode = errorCodes[i] || 0;
                const enabled = (sw & 0x006F) === 0x0027;
                const fault = (sw & 0x0008) !== 0;

                // Check if this slave is currently moving
                const isMoving = currentMovingSlaves.includes(i);
                const moveOrderIndex = currentMoveOrder.indexOf(i);
                const orderBadge = moveOrderIndex >= 0 ? `<span style="background: var(--accent-blue); color: white; padding: 1px 5px; border-radius: 10px; font-size: 0.7em; margin-left: 5px;">#${moveOrderIndex + 1}</span>` : '';

                let statusClass = 'disabled';
                let statusText = 'Disabled';

                if (fault) {
                    statusClass = 'fault';
                    // Get error info from Leadshine CS3E error table
                    const errorInfo = getErrorInfo(errorCode);
                    // Format: Name (0x603F) [E###] - matching physical drive display
                    const hexCode = errorCode.toString(16).toUpperCase();
                    statusText = `${errorInfo.name} (0x${hexCode}) [${errorInfo.display}]`;
                } else if (enabled) {
                    statusClass = 'enabled';
                    statusText = 'Enabled';
                }

                // Highlight row if slave is moving
                const rowStyle = isMoving ? 'background: rgba(59, 130, 246, 0.2); border-left: 3px solid var(--accent-blue);' : '';
                const movingIndicator = isMoving ? '<span style="color: var(--accent-blue); animation: pulse 1s infinite;">‚óè</span> ' : '';

                html += `
                    <tr style="${rowStyle}">
                        <td class="td-status"><span class="status-icon ${statusClass}"></span></td>
                        <td>${movingIndicator}#${String(i + 1).padStart(2, '0')}${orderBadge}</td>
                        <td>${pos}</td>
                        <td style="color: ${fault ? 'var(--accent-red)' : 'inherit'}; font-weight: ${fault ? 'bold' : 'normal'}">${statusText}</td>
                    </tr>
                `;
            }

            if (html) tbody.innerHTML = html;
        }

        // Set moving slaves for highlighting
        function setMovingSlaves(slaves, moveOrder) {
            currentMovingSlaves = slaves || [];
            currentMoveOrder = moveOrder || [];
        }

        // Clear moving slaves highlight
        function clearMovingSlaves() {
            currentMovingSlaves = [];
            currentMoveOrder = [];
        }
        
        // Leadshine EL7-EC Error Code Table (synced with backend ethercat_controller.py)
        // Maps SDO 0x603F values to drive display codes (Er###) and descriptions
        // Based on Table 8.2 from EL7-EC_Series_AC_Servo_Drive_User_Manual_V1_00.pdf
        function getErrorInfo(code) {
            // Map from 0x603F (IEC 61800) to display code (Er###) and description
            const errorTable = {
                // Current/Power errors (0x0A - 0x0E)
                0x3150: { display: 'Er0A0', name: 'Phase A Current Error', desc: 'Phase A circuit current detection error' },
                0x3151: { display: 'Er0A1', name: 'Phase B Current Error', desc: 'Phase B circuit current detection error' },
                0x3153: { display: 'Er0A3', name: 'Motor Not Connected', desc: 'Motor power cable not connected' },
                0x3206: { display: 'Er0b1', name: 'Control Overvoltage', desc: 'Control power supply voltage too high' },
                0x3211: { display: 'Er0C0', name: 'DC Bus Overvoltage', desc: 'DC bus overvoltage' },
                0x3221: { display: 'Er0d0', name: 'DC Bus Undervoltage', desc: 'DC bus undervoltage' },
                0x3130: { display: 'Er0d1', name: 'Single Phase', desc: 'Single phasing of main power supply' },
                0x3222: { display: 'Er0d2', name: 'No Main Power', desc: 'No main power supply detected' },
                0x2211: { display: 'Er0E0', name: 'Overcurrent', desc: 'Overcurrent detected' },
                0x2212: { display: 'Er0E1', name: 'IPM Overcurrent', desc: 'IPM overcurrent' },
                0x2218: { display: 'Er0E2', name: 'Ground Short', desc: 'Power output to motor shorted to ground' },
                0x2230: { display: 'Er0E4', name: 'Phase Overcurrent', desc: 'Phase overcurrent' },

                // Thermal/Load errors (0x0F - 0x12)
                0x4210: { display: 'Er0f0', name: 'Driver Overheat', desc: 'Driver overheated' },
                0x8311: { display: 'Er100', name: 'Motor Overload', desc: 'Motor overloaded' },
                0x8310: { display: 'Er101', name: 'Driver Overload', desc: 'Driver overloaded' },
                0x8301: { display: 'Er102', name: 'Motor Blocked', desc: 'Motor rotor blocked' },
                0x7701: { display: 'Er120', name: 'Regen Overvoltage', desc: 'Regenerative resistor overvoltage' },
                0x7702: { display: 'Er121', name: 'Brake Error', desc: 'Holding brake error' },
                0x7703: { display: 'Er122', name: 'Regen Resistance Low', desc: 'Regenerative resistor value too low' },

                // Encoder errors (0x15 - 0x17)
                0x7321: { display: 'Er150', name: 'Encoder Disconnected', desc: 'Encoder disconnected' },
                0x7322: { display: 'Er151', name: 'Encoder Comm Error', desc: 'Encoder communication error' },
                0x7323: { display: 'Er152', name: 'Encoder Init Error', desc: 'Encoder initial position error' },
                0x7325: { display: 'Er153', name: 'Multiturn Error', desc: 'Multiturn encoder error (requires Pr0.15 to clear)' },
                0x7326: { display: 'Er155', name: 'Encoder Overflow', desc: 'Encoder data overflow' },
                0x7327: { display: 'Er156', name: 'Encoder Overheat', desc: 'Encoder overheated' },
                0x7328: { display: 'Er157', name: 'Encoder Count Error', desc: 'Encoder count error' },
                0x7324: { display: 'Er170', name: 'Encoder Data Error', desc: 'Encoder data error' },

                // Motion errors (0x18 - 0x1C)
                0x8611: { display: 'Er180', name: 'Position Deviation', desc: 'Excessive position deviation' },
                0x8401: { display: 'Er190', name: 'Motor Vibration', desc: 'Motor vibration too strong' },
                0x8402: { display: 'Er1A0', name: 'Overspeed', desc: 'Overspeed detected' },
                0x8403: { display: 'Er1A1', name: 'Velocity Out of Control', desc: 'Velocity out of control' },
                0x8612: { display: 'Er1b0', name: 'Bus Signal Dither', desc: 'Bus input signal dithering' },
                0x8503: { display: 'Er1b1', name: 'Gear Ratio Error', desc: 'Incorrect electronic gear ratio' },
                0x8313: { display: 'Er1c0', name: 'STO Failed', desc: 'STO failed' },

                // I/O errors (0x21)
                0x6321: { display: 'Er210', name: 'I/O Input Assign Error', desc: 'I/O input interface assignment error' },
                0x6322: { display: 'Er211', name: 'I/O Input Func Error', desc: 'I/O input interface function assignment error' },
                0x6323: { display: 'Er212', name: 'I/O Output Func Error', desc: 'I/O output interface function assignment error' },

                // EEPROM errors (0x24)
                0x5530: { display: 'Er240', name: 'EEPROM Init Error', desc: 'EEPROM parameters initialization error' },
                0x5531: { display: 'Er241', name: 'EEPROM HW Error', desc: 'EEPROM hardware error' },
                0x5532: { display: 'Er242', name: 'Alarm History Error', desc: 'Error saving alarm history record' },
                0x5533: { display: 'Er243', name: 'Vendor Param Error', desc: 'Error saving vendor parameters' },
                0x5534: { display: 'Er244', name: 'Comm Param Error', desc: 'Error saving communication parameters' },
                0x5535: { display: 'Er245', name: 'Param 402 Error', desc: 'Error saving parameter 402' },
                0x5536: { display: 'Er246', name: 'Power-off Save Error', desc: 'Data saving error during power-off' },

                // Position/Other errors (0x26 - 0x28)
                0x7329: { display: 'Er260', name: 'Limit Triggered', desc: 'Positive/Negative limit triggered' },
                0x7201: { display: 'Er280', name: 'Pulse Freq Too High', desc: 'Output pulse frequency too high' },

                // Special errors (0x5 - 0x7)
                0x5441: { display: 'Er570', name: 'Quick Stop', desc: 'Forced alarm input valid (Quick Stop)' },
                0x7122: { display: 'Er5f0', name: 'Motor Detection Error', desc: 'Motor model detection error' },
                0x1100: { display: 'Er5f1', name: 'Power Module Error', desc: 'Driver power module detection error' },
                0x6204: { display: 'Er600', name: 'Loop Timeout', desc: 'Main/velocity loop interrupted timeout' },
                0x7001: { display: 'Er700', name: 'Encryption Error', desc: 'Encryption error' },

                // EtherCAT sync errors (0x73)
                0x873A: { display: 'Er73A', name: 'SM2 Lost', desc: 'SyncManager2 lost' },
                0x873B: { display: 'Er73b', name: 'SYNC0 Lost', desc: 'SYNC0 lost' },
                0x873C: { display: 'Er73c', name: 'DC Error', desc: 'Excessive Distributed Clock error' },

                // EtherCAT communication errors (0x80 - 0x8)
                0x8201: { display: 'Er801', name: 'Unknown Comm Error', desc: 'Unknown communication error' },
                0x5510: { display: 'Er802', name: 'Memory Overflow', desc: 'Memory overflow' },
                0x5511: { display: 'Er803', name: 'RAM Out of Bound', desc: 'RAM out of bound' },
                0x6202: { display: 'Er805', name: 'FOE Upgrade Failed', desc: 'FOE firmware upgrade failed' },
                0x6201: { display: 'Er806', name: 'ESI Mismatch', desc: 'ESI file mismatch' },
                0xA001: { display: 'Er811', name: 'Invalid ESM Request', desc: 'Invalid EtherCAT transition request' },
                0xA002: { display: 'Er812', name: 'Unknown ESM Request', desc: 'Unknown EtherCAT transition request' },
                0x8213: { display: 'Er813', name: 'Boot Protection', desc: 'Protection request from boot state' },
                0x6203: { display: 'Er814', name: 'Invalid Boot Config', desc: 'Invalid boot configuration' },
                0x8215: { display: 'Er815', name: 'Boot Mailbox Error', desc: 'Invalid mailbox configuration (boot)' },
                0x8216: { display: 'Er816', name: 'PreOp Mailbox Error', desc: 'Invalid mailbox configuration (pre-op)' },
                0x8217: { display: 'Er817', name: 'Invalid SM Config', desc: 'Invalid SyncManager configuration' },
                0x8211: { display: 'Er818', name: 'No Valid Input', desc: 'No valid input data' },
                0x8212: { display: 'Er819', name: 'No Valid Output', desc: 'No valid output data' },
                0xFF02: { display: 'Er81A', name: 'Sync Error', desc: 'Synchronization error' },
                0x821B: { display: 'Er81b', name: 'Watchdog Timeout', desc: 'SyncManager2 watchdog timeout - check network cable' },
                0x821C: { display: 'Er81C', name: 'Invalid SM Type', desc: 'Invalid SyncManager type' },
                0x821D: { display: 'Er81d', name: 'Invalid Output Config', desc: 'Invalid output configuration' },
                0x821E: { display: 'Er81E', name: 'Invalid Input Config', desc: 'Invalid input configuration' },
                0x8224: { display: 'Er824', name: 'Invalid Input Map', desc: 'Invalid input mapping' },
                0x8225: { display: 'Er825', name: 'Invalid Output Map', desc: 'Invalid output mapping' },
                0x8728: { display: 'Er828', name: 'Sync Mode Not Supported', desc: 'Sync mode not supported' },
                0x872C: { display: 'Er82c', name: 'Fatal Sync Error', desc: 'Fatal sync error (DC watchdog)' },
                0x872D: { display: 'Er82d', name: 'No Sync Error', desc: 'No sync error' },
                0x872E: { display: 'Er82E', name: 'Sync Cycle Too Short', desc: 'Sync cycle too short' },
                0x8730: { display: 'Er830', name: 'Invalid DC Sync', desc: 'Invalid DC sync settings' },
                0x8732: { display: 'Er832', name: 'DC PLL Failure', desc: 'DC PLL failure' },
                0x8735: { display: 'Er835', name: 'DC Cycle Invalid', desc: 'DC cycle time invalid' },
                0x8736: { display: 'Er836', name: 'Invalid DC Sync Cycle', desc: 'Invalid DC sync cycle time' },
                0x5550: { display: 'Er850', name: 'EEPROM Inaccessible', desc: 'EEPROM inaccessible' },
                0x5551: { display: 'Er851', name: 'EEPROM Error', desc: 'EEPROM error' },
                0x5552: { display: 'Er852', name: 'Hardware Not Ready', desc: 'Hardware not ready' }
            };

            // Try to find in table by 0x603F code
            if (errorTable[code]) {
                return errorTable[code];
            }

            // Unknown error - generate Er format from hex (matching backend format)
            return { display: 'Er' + code.toString(16).toUpperCase().padStart(3, '0'), name: 'Unknown Error', desc: 'Unknown error code: 0x' + code.toString(16).toUpperCase() };
        }

        // Convert 0x603F code to drive display format (Er### as shown on physical drive)
        function getDriveDisplayCode(code) {
            const info = getErrorInfo(code);
            return info.display || ('Er' + code.toString(16).toUpperCase().padStart(3, '0'));
        }

        // Update slave selector dropdown
        function updateSlaveSelector(count) {
            const select = document.getElementById('slaveSelect');
            const selectVel = document.getElementById('slaveSelectVel');
            const selectHome = document.getElementById('homeSlaveSelect');
            const selectClearError = document.getElementById('clearErrorSlaveSelect');

            // Save current selections
            const currentPos = select.value;
            const currentVel = selectVel.value;
            const currentHome = selectHome.value;
            const currentClearError = selectClearError.value;

            // Only update if count changed
            const currentCount = select.options.length - 1;
            if (currentCount === count && count > 0) {
                return;
            }

            let html = '<option value="">-- Select Slave --</option>';
            for (let i = 0; i < count; i++) {
                html += `<option value="${i}">Slave #${i + 1}</option>`;
            }
            select.innerHTML = html;
            selectVel.innerHTML = html;
            selectHome.innerHTML = html;
            selectClearError.innerHTML = html;

            // Restore selections if valid
            if (currentPos !== '' && parseInt(currentPos) < count) {
                select.value = currentPos;
            }
            if (currentVel !== '' && parseInt(currentVel) < count) {
                selectVel.value = currentVel;
            }
            if (currentHome !== '' && parseInt(currentHome) < count) {
                selectHome.value = currentHome;
            }
            if (currentClearError !== '' && parseInt(currentClearError) < count) {
                selectClearError.value = currentClearError;
            }

            // Update button states
            updateButtonStates();
        }

        // Update button states based on slave selection
        function updateButtonStates() {
            const posSlaveSelected = document.getElementById('slaveSelect').value !== '';
            const velSlaveSelected = document.getElementById('slaveSelectVel').value !== '';
            const homeSlaveSelected = document.getElementById('homeSlaveSelect').value !== '';
            const clearErrorSlaveSelected = document.getElementById('clearErrorSlaveSelect').value !== '';

            // Position mode buttons (except All to Home and Emergency Stop which have separate logic)
            document.querySelectorAll('#positionControls button').forEach(btn => {
                if (btn.id === 'allToHomeBtn' || btn.id === 'emergencyStopBtn') return; // Skip - have separate control logic
                btn.disabled = !posSlaveSelected;
                btn.style.opacity = posSlaveSelected ? '1' : '0.5';
                btn.style.cursor = posSlaveSelected ? 'pointer' : 'not-allowed';
            });

            // Velocity mode buttons
            document.querySelectorAll('#velocityControls button').forEach(btn => {
                btn.disabled = !velSlaveSelected;
                btn.style.opacity = velSlaveSelected ? '1' : '0.5';
                btn.style.cursor = velSlaveSelected ? 'pointer' : 'not-allowed';
            });

            // Home button
            const homeBtn = document.querySelector('#homeSlaveSelect').parentElement.querySelector('button');
            if (homeBtn) {
                homeBtn.disabled = !homeSlaveSelected;
                homeBtn.style.opacity = homeSlaveSelected ? '1' : '0.5';
                homeBtn.style.cursor = homeSlaveSelected ? 'pointer' : 'not-allowed';
            }

            // Clear Error button
            const clearErrorBtn = document.getElementById('clearErrorBtn');
            if (clearErrorBtn) {
                clearErrorBtn.disabled = !clearErrorSlaveSelected;
                clearErrorBtn.style.opacity = clearErrorSlaveSelected ? '1' : '0.5';
                clearErrorBtn.style.cursor = clearErrorSlaveSelected ? 'pointer' : 'not-allowed';
            }
        }

        // Handle response
        function handleResponse(resp) {
            console.log('Response received:', resp);
            
            if (resp.success) {
                log(resp.message, 'sys');
                
                // Template-specific messages
                if (resp.message.includes('Running template')) {
                    templateLog('‚ñ∂ ' + resp.message, 'config');
                } else if (resp.message.includes('Executing:')) {
                    // This is a step execution - logged via template_step
                } else if (resp.message.includes('Template complete')) {
                    templateLog('‚úì ' + resp.message, 'complete');
                } else if (resp.message.includes('Template stopped')) {
                    templateLog('‚ñ† ' + resp.message, 'stop');
                } else if (resp.message.includes('fault') || resp.message.includes('FAULT')) {
                    templateLog('‚ö†Ô∏è ' + resp.message, 'error');
                }
            } else {
                log(resp.message, 'err');
                if (resp.message.includes('Template') || resp.message.includes('template') || 
                    resp.message.includes('fault') || resp.message.includes('FAULT')) {
                    templateLog('‚úó ' + resp.message, 'error');
                }
            }
            
            // Update interface display if provided
            if (resp.data && resp.data.interface) {
                document.getElementById('interfaceDisplay').textContent = resp.data.interface;
            }
            
            // Update config info if provided
            if (resp.data && resp.data.config) {
                console.log('Config data:', resp.data.config);
                updateConfigInfo(resp.data.config);
            }
            
            // Handle template step updates
            if (resp.data && resp.data.template_step) {
                const step = resp.data.template_step;
                templateLog(`[${step.index}/${step.total}] ${step.name} (${step.type})`, 'step');

                // Handle step timing events
                if (step.event === 'start') {
                    startStepTimer(step.index);

                    // Set moving slaves for highlighting
                    if (step.moving_slaves) {
                        setMovingSlaves(step.moving_slaves, step.move_order || []);
                    }

                    // Update move order display for this step
                    if (step.move_order && step.move_order.length > 0) {
                        updateStepMoveOrder(step.index, step.move_order, step.is_spreading);
                    }

                    // Log movement mode
                    if (step.is_simultaneous === false) {
                        templateLog(`  Mode: Staggered (${step.slave_delay_ms}ms delay)`, 'config');
                    }

                    // Display move order details in log window
                    if (step.order_details && step.order_details.log) {
                        updateMoveOrderLog(step.order_details.log);
                    }
                } else if (step.event === 'complete') {
                    completeStepTimer(step.index, step.time_taken || 0);
                    // Clear moving slaves highlight when step completes
                    clearMovingSlaves();
                }
            }

            // Handle template start event (reset timings)
            if (resp.data && resp.data.template_start) {
                resetStepTimings();
                clearMovingSlaves();  // Clear any previous slave highlights
                templateLog('‚ñ∂ Template started', 'config');
            }

            // Handle template complete event
            if (resp.data && resp.data.template_complete) {
                stopStepTimer();
                clearMovingSlaves();  // Clear slave highlights when template completes
                const total = resp.data.template_complete.total_time;
                if (total) {
                    templateLog(`‚úì Template complete (Total: ${total.toFixed(1)}s)`, 'complete');
                }
            }

            if (resp.data && resp.data.template_move) {
                const move = resp.data.template_move;
                templateLog(`  ‚Üí Slave ${move.slave}: ${move.position}`, 'move');
            }

            // Handle UDP log entries
            if (resp.data && resp.data.udp_log) {
                addUdpLogEntry(resp.data.udp_log);
            }

            // Handle OSC log entries
            if (resp.data && resp.data.osc_log) {
                addOscLogEntry(resp.data.osc_log);
            }

            // Handle config files list
            if (resp.data && resp.data.config_files) {
                console.log('Config files received:', resp.data.config_files);
                updateConfigList(resp.data.config_files);
            }
        }

        // Store loaded config globally for template execution
        let loadedConfig = null;

        // Template step timing tracking
        let stepTimings = {};  // { stepIndex: { startTime, endTime, elapsed } }
        let currentStepIndex = null;
        let stepTimerInterval = null;

        // Update template display as table
        function updateTemplateDisplay(template, positions) {
            const nameEl = document.getElementById('templateName');
            const tbody = document.getElementById('templateTableBody');

            if (!template || !template.steps || template.steps.length === 0) {
                nameEl.textContent = 'No template loaded';
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">Load a config file to see steps</td></tr>';
                return;
            }

            const opMode = template.operation_mode || 'both';
            nameEl.innerHTML = `${template.name || 'SEQUENCE'} <span style="color: var(--text-secondary); font-size: 0.8rem;">(${opMode} | Loop: ${template.loop || false}, Count: ${template.loop_count || 1})</span>`;

            let html = '';
            template.steps.forEach((step, i) => {
                const stepType = step.type || 'all';

                // Resolve position reference
                let positionDisplay = '‚Äî';
                const posRef = step.position;
                const posRotRef = step.position_rotation;

                if (posRef && positions && positions[posRef]) {
                    positionDisplay = `[${positions[posRef].join(', ')}]`;
                } else if (posRef) {
                    positionDisplay = posRef;
                }

                // For 'all' type, show both positions
                if (stepType === 'all' && posRotRef && positions && positions[posRotRef]) {
                    positionDisplay += ` / [${positions[posRotRef].join(', ')}]`;
                } else if (stepType === 'all' && posRotRef) {
                    positionDisplay += ` / ${posRotRef}`;
                }

                const typeColor = stepType === 'movement' ? 'var(--accent-green)' :
                                  stepType === 'rotation' ? 'var(--accent-blue)' :
                                  stepType === 'home' ? 'var(--accent-red)' : 'var(--text-gold)';
                const typeLabel = stepType.charAt(0).toUpperCase() + stepType.slice(1);

                // Get timing info if available
                const timing = stepTimings[i + 1];
                let timeDisplay = '‚Äî';
                let timeColor = 'var(--text-secondary)';
                if (timing) {
                    if (timing.elapsed !== undefined) {
                        timeDisplay = timing.elapsed.toFixed(1) + 's';
                        timeColor = 'var(--accent-green)';
                    }
                }

                html += `<tr id="step-row-${i + 1}">
                    <td>${i + 1}</td>
                    <td>${step.name || 'Step'}</td>
                    <td style="color: ${typeColor};">${typeLabel}</td>
                    <td>${positionDisplay}</td>
                    <td>${step.delay || 0}s</td>
                    <td id="step-time-${i + 1}" style="color: ${timeColor}; font-weight: bold;">${timeDisplay}</td>
                    <td id="step-order-${i + 1}" style="color: var(--text-secondary); font-size: 0.75rem;">‚Äî</td>
                </tr>`;
            });
            tbody.innerHTML = html;

            log(`Template: ${template.name} (${template.steps.length} steps)`, 'sys');
        }

        // Start tracking time for a step
        function startStepTimer(stepIndex) {
            // Stop previous timer if any
            stopStepTimer();

            currentStepIndex = stepIndex;
            stepTimings[stepIndex] = { startTime: Date.now(), elapsed: 0 };

            // Highlight current step row
            const row = document.getElementById(`step-row-${stepIndex}`);
            if (row) {
                row.style.background = 'rgba(88, 166, 255, 0.15)';
                row.style.borderLeft = '3px solid var(--accent-blue)';
            }

            // Update time cell to show running
            const timeCell = document.getElementById(`step-time-${stepIndex}`);
            if (timeCell) {
                timeCell.style.color = 'var(--accent-blue)';
                timeCell.textContent = '0.0s';
            }

            // Start real-time timer update
            stepTimerInterval = setInterval(() => {
                if (stepTimings[stepIndex]) {
                    const elapsed = (Date.now() - stepTimings[stepIndex].startTime) / 1000;
                    stepTimings[stepIndex].elapsed = elapsed;

                    const timeCell = document.getElementById(`step-time-${stepIndex}`);
                    if (timeCell) {
                        timeCell.textContent = elapsed.toFixed(1) + 's';
                    }
                }
            }, 100);  // Update every 100ms
        }

        // Stop the current step timer
        function stopStepTimer() {
            if (stepTimerInterval) {
                clearInterval(stepTimerInterval);
                stepTimerInterval = null;
            }

            if (currentStepIndex) {
                // Remove highlight from previous step
                const row = document.getElementById(`step-row-${currentStepIndex}`);
                if (row) {
                    row.style.background = '';
                    row.style.borderLeft = '';
                }
            }
        }

        // Complete a step and record final time
        function completeStepTimer(stepIndex, totalTime) {
            stopStepTimer();

            if (stepTimings[stepIndex]) {
                stepTimings[stepIndex].elapsed = totalTime;
            } else {
                stepTimings[stepIndex] = { elapsed: totalTime };
            }

            // Update time cell with final value
            const timeCell = document.getElementById(`step-time-${stepIndex}`);
            if (timeCell) {
                timeCell.style.color = 'var(--accent-green)';
                timeCell.textContent = totalTime.toFixed(1) + 's';
            }

            // Mark row as completed
            const row = document.getElementById(`step-row-${stepIndex}`);
            if (row) {
                row.style.background = 'rgba(63, 185, 80, 0.1)';
                row.style.borderLeft = '3px solid var(--accent-green)';
            }

            currentStepIndex = null;
        }

        // Reset all step timings (when starting new template run)
        function resetStepTimings() {
            stopStepTimer();
            stepTimings = {};
            currentStepIndex = null;

            // Reset all row styles and time/order displays
            const tbody = document.getElementById('templateTableBody');
            if (tbody) {
                const rows = tbody.querySelectorAll('tr[id^="step-row-"]');
                rows.forEach(row => {
                    row.style.background = '';
                    row.style.borderLeft = '';
                });

                const timeCells = tbody.querySelectorAll('td[id^="step-time-"]');
                timeCells.forEach(cell => {
                    cell.style.color = 'var(--text-secondary)';
                    cell.textContent = '‚Äî';
                });

                // Reset order cells
                const orderCells = tbody.querySelectorAll('td[id^="step-order-"]');
                orderCells.forEach(cell => {
                    cell.style.color = 'var(--text-secondary)';
                    cell.textContent = '‚Äî';
                });
            }
        }

        // Update move order display for a step (only for movement slaves)
        function updateStepMoveOrder(stepIndex, moveOrder, isSpreading) {
            const orderCell = document.getElementById(`step-order-${stepIndex}`);
            if (!orderCell) return;

            if (!moveOrder || moveOrder.length === 0) {
                orderCell.textContent = '‚Äî';
                orderCell.style.color = 'var(--text-secondary)';
                return;
            }

            // Format: "0‚Üí1‚Üí2‚Üí3" with spreading/converging indicator
            const orderStr = moveOrder.map(s => s + 1).join('‚Üí');
            const indicator = isSpreading ? '‚Üî' : '‚Üí‚Üê';  // Spreading or converging symbol

            orderCell.innerHTML = `<span style="color: ${isSpreading ? 'var(--accent-blue)' : 'var(--accent-green)'};">${indicator}</span> ${orderStr}`;
            orderCell.style.color = 'var(--text-primary)';
            orderCell.title = isSpreading ? 'Spreading (moving apart)' : 'Converging (moving together)';
        }
        
        // Update config info display
        function updateConfigInfo(config) {
            loadedConfig = config;
            
            const infoEl = document.getElementById('configInfo');
            infoEl.style.display = 'block';
            
            // Operation mode from template
            const template = config.template || {};
            document.getElementById('cfgOpMode').textContent = template.operation_mode || 'both';
            
            // Slaves section
            const slavesConfig = config.slaves || {};
            const movementSlaves = slavesConfig.movement_slaves || [];
            const rotationSlaves = slavesConfig.rotation_slaves || [];
            
            document.getElementById('cfgSlaveCount').textContent = slavesConfig.count || 0;
            document.getElementById('cfgMovementSlaves').textContent = movementSlaves.length > 0 ? 
                `[${movementSlaves.map(s => s + 1).join(', ')}]` : '‚Äî';
            document.getElementById('cfgRotationSlaves').textContent = rotationSlaves.length > 0 ? 
                `[${rotationSlaves.map(s => s + 1).join(', ')}]` : '‚Äî';
            
            // Speed section
            const speed = config.speed || {};
            if (speed.movement_speed) {
                const ms = speed.movement_speed;
                document.getElementById('cfgMovementSpeed').textContent = 
                    `V:${ms.velocity?.toLocaleString()}, A:${ms.acceleration?.toLocaleString()}`;
                
                // Update speed inputs (convert to simplified units)
                const velocity = ms.velocity || 80000;
                document.getElementById('ppSpeed').value = Math.round(velocity / 1000);
                document.getElementById('cspMaxStep').value = ms.csp_max_step || 800;
                updatePPEffective();
                updateCSPEffective();
            } else {
                document.getElementById('cfgMovementSpeed').textContent = '‚Äî';
            }
            
            if (speed.rotation_speed) {
                const rs = speed.rotation_speed;
                document.getElementById('cfgRotationSpeed').textContent =
                    `V:${rs.velocity?.toLocaleString()}, A:${rs.acceleration?.toLocaleString()}`;
            } else {
                document.getElementById('cfgRotationSpeed').textContent = '‚Äî';
            }

            // Movement mode display (simultaneous vs staggered)
            const isSimultaneous = template.is_simultaneous !== false;  // Default to true
            const slaveDelay = template.slave_delay_ms || 10;
            if (isSimultaneous) {
                document.getElementById('cfgMovementMode').textContent = 'Simultaneous (all at once)';
                document.getElementById('cfgMovementMode').style.color = 'var(--accent-green)';
            } else {
                document.getElementById('cfgMovementMode').textContent = `Staggered (${slaveDelay}ms delay)`;
                document.getElementById('cfgMovementMode').style.color = 'var(--accent-blue)';
            }

            // Update template display with positions
            updateTemplateDisplay(template, config.positions);

            log(`Config loaded: ${movementSlaves.length} movement, ${rotationSlaves.length} rotation slaves`, 'sys');
        }
        
        // Apply steps per meter config
        function applyStepsConfig() {
            const actualSteps = parseInt(document.getElementById('actualStepsInput').value) || 792914;
            const rawSteps = parseInt(document.getElementById('rawStepsInput').value) || 202985985;
            
            sendCmd('set_steps_config', { 
                actual_steps_per_meter: actualSteps, 
                raw_steps_per_meter: rawSteps 
            });
            log(`Steps config: Actual=${actualSteps.toLocaleString()}, Raw=${rawSteps.toLocaleString()}`, 'com');
        }

        // Send command
        function sendCmd(cmd, data = null) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ cmd, data }));
                if (cmd !== 'load_config') {
                    log(`Command: ${cmd}`, 'com');
                }
            } else {
                log('WebSocket not connected', 'err');
            }
        }

        // Change mode (PP/CSP/PV)
        function changeMode() {
            const mode = parseInt(document.getElementById('modeSelector').value);
            sendCmd('set_mode', { mode: mode });
            
            const modeNames = {1: 'PP', 3: 'PV', 8: 'CSP'};
            log(`Changing mode to ${modeNames[mode] || mode}`, 'com');
            
            updateModeUI(mode);
        }
        
        // Update UI based on mode
        function updateModeUI(mode) {
            const positionControls = document.getElementById('positionControls');
            const velocityControls = document.getElementById('velocityControls');
            const templateSection = document.getElementById('templateSection');
            const speedPP = document.getElementById('speedPP');
            const speedCSP = document.getElementById('speedCSP');
            const speedPV = document.getElementById('speedPV');
            
            speedPP.style.display = 'none';
            speedCSP.style.display = 'none';
            speedPV.style.display = 'none';
            
            if (mode === 3) {
                positionControls.style.display = 'none';
                velocityControls.style.display = 'block';
                templateSection.style.opacity = '0.3';
                templateSection.style.pointerEvents = 'none';
                speedPV.style.display = 'block';
            } else if (mode === 8) {
                positionControls.style.display = 'block';
                velocityControls.style.display = 'none';
                templateSection.style.opacity = '1';
                templateSection.style.pointerEvents = 'auto';
                speedCSP.style.display = 'block';
            } else {
                positionControls.style.display = 'block';
                velocityControls.style.display = 'none';
                templateSection.style.opacity = '1';
                templateSection.style.pointerEvents = 'auto';
                speedPP.style.display = 'block';
            }
        }
        
        // Velocity control functions
        function velocityForward() {
            const slave = document.getElementById('slaveSelectVel').value;
            if (!slave) {
                log('Please select a slave first', 'err');
                return;
            }
            const speedUnit = parseInt(document.getElementById('pvSpeed').value) || 50;
            const speed = speedUnit * 1000;
            sendCmd('velocity_forward', { slave: slave, speed: speed });
            log(`Slave #${parseInt(slave) + 1} Forward: ${speed} units/s`, 'com');
        }

        function velocityBackward() {
            const slave = document.getElementById('slaveSelectVel').value;
            if (!slave) {
                log('Please select a slave first', 'err');
                return;
            }
            const speedUnit = parseInt(document.getElementById('pvSpeed').value) || 50;
            const speed = speedUnit * 1000;
            sendCmd('velocity_backward', { slave: slave, speed: speed });
            log(`Slave #${parseInt(slave) + 1} Backward: ${speed} units/s`, 'com');
        }
        
        function velocityStop() {
            const slave = document.getElementById('slaveSelectVel').value;
            if (!slave) {
                log('Please select a slave first', 'err');
                return;
            }
            sendCmd('velocity_stop', { slave: slave });
            log(`Slave #${parseInt(slave) + 1} STOP`, 'wrn');
        }
        
        // Emergency Stop
        function emergencyStop() {
            sendCmd('stop');
            log('EMERGENCY STOP - All motion stopped!', 'err');

            // Disable emergency stop button after stopping
            const emergencyStopBtn = document.getElementById('emergencyStopBtn');
            if (emergencyStopBtn) {
                emergencyStopBtn.disabled = true;
                emergencyStopBtn.style.opacity = '0.5';
                emergencyStopBtn.style.cursor = 'not-allowed';
            }
        }

        // Move to position
        function moveTo(pos) {
            const slaveSelect = document.getElementById('slaveSelect').value;
            
            if (!slaveSelect) {
                log('Please select a slave first', 'err');
                return;
            }
            
            sendCmd('move', { positions: [pos], slave: slaveSelect });
            log(`Moving Slave #${parseInt(slaveSelect) + 1} to ${pos}m`, 'com');
        }

        // Execute custom move
        function executeMove() {
            const target = parseFloat(document.getElementById('targetPosition').value);
            if (isNaN(target)) {
                log('Invalid target position', 'err');
                return;
            }
            moveTo(target);
        }

        // Move all slaves to home (0m) position
        function moveAllToHome() {
            sendCmd('move_all_home');
            log('Moving ALL slaves to home (0m)...', 'com');

            // Enable emergency stop button when moving
            const emergencyStopBtn = document.getElementById('emergencyStopBtn');
            if (emergencyStopBtn) {
                emergencyStopBtn.disabled = false;
                emergencyStopBtn.style.opacity = '1';
                emergencyStopBtn.style.cursor = 'pointer';
            }
        }

        // Set Home for specific slave
        function setHome() {
            const slave = document.getElementById('homeSlaveSelect').value;
            if (!slave) {
                log('Please select a slave first', 'err');
                return;
            }
            sendCmd('set_home', { slave: slave });
            log(`Setting home for Slave #${parseInt(slave) + 1}`, 'com');
        }

        // Set Home for all slaves
        function setHomeAll() {
            if (!confirm('Set home position for ALL slaves? This will disable and re-enable each slave.')) {
                return;
            }
            sendCmd('set_home_all');
            log('Setting home for all slaves...', 'com');
        }

        // Clear error for specific slave
        function clearError() {
            const slave = document.getElementById('clearErrorSlaveSelect').value;
            if (!slave) {
                log('Please select a slave first', 'err');
                return;
            }
            sendCmd('clear_error', { slave: slave, method: 'all' });
            log(`Clearing error for Slave #${parseInt(slave) + 1}...`, 'com');
        }

        // Terminate program - quits backend and closes UI
        function terminateProgram() {
            if (!confirm('Are you sure you want to terminate the program?\n\nThis will disable all drives and shut down the server.')) {
                return;
            }

            // Set terminating flag to prevent reconnection attempts
            isTerminating = true;

            // Clear any pending reconnection timer
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }

            log('Terminating program...', 'err');
            sendCmd('quit');

            // Close the browser tab after a short delay
            setTimeout(() => {
                // Try to close the tab
                window.open('', '_self').close();
                window.close();

                // If still open, replace page content with termination message
                setTimeout(() => {
                    document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#0d1117;color:#f85149;font-size:24px;font-family:sans-serif;">Program terminated. You can close this tab.</div>';
                }, 300);
            }, 200);
        }

        // UDP Connect
        function udpConnect() {
            const ip = document.getElementById('udpIp').value || '0.0.0.0';
            const port = parseInt(document.getElementById('udpPort').value) || 9000;
            sendCmd('udp_connect', { ip: ip, port: port });
            log(`Connecting UDP: ${ip}:${port}...`, 'com');
        }

        // UDP Disconnect
        function udpDisconnect() {
            sendCmd('udp_disconnect');
            log('Disconnecting UDP...', 'com');
        }

        // Update UDP status from status updates
        function updateUdpStatus(udpConnected) {
            const dot = document.getElementById('udpStatusDot');
            const text = document.getElementById('udpStatusText');
            const connectBtn = document.getElementById('udpConnectBtn');
            const disconnectBtn = document.getElementById('udpDisconnectBtn');

            if (udpConnected) {
                dot.className = 'status-dot enabled';
                text.textContent = 'Connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                dot.className = 'status-dot disconnected';
                text.textContent = 'Disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        // OSC Connect
        function oscConnect() {
            const sendIp = document.getElementById('oscSendIp').value || '127.0.0.1';
            const sendPort = parseInt(document.getElementById('oscSendPort').value) || 9000;
            const recvIp = document.getElementById('oscRecvIp').value || '0.0.0.0';
            const recvPort = parseInt(document.getElementById('oscRecvPort').value) || 8001;
            const modeRadio = document.querySelector('input[name="oscMode"]:checked');
            const mode = modeRadio ? parseInt(modeRadio.value) : 3;  // 1=recv, 2=send, 3=both
            const modeNames = {1: 'Receive', 2: 'Send', 3: 'Both'};
            sendCmd('osc_connect', {
                send_ip: sendIp,
                send_port: sendPort,
                recv_ip: recvIp,
                recv_port: recvPort,
                mode: mode
            });
            log(`Starting OSC (${modeNames[mode]}): Recv ${recvIp}:${recvPort}, Send ${sendIp}:${sendPort}`, 'com');

            // Store for display
            window.oscConfig = { sendIp, sendPort, recvIp, recvPort, mode };
        }

        // OSC Disconnect
        function oscDisconnect() {
            sendCmd('osc_disconnect');
            log('Stopping OSC...', 'com');
            window.oscConfig = null;
        }

        // Update OSC status from status updates
        function updateOscStatus(oscConnected, oscMode, oscIp, oscPort) {
            const dot = document.getElementById('oscStatusDot');
            const text = document.getElementById('oscStatusText');
            const connectBtn = document.getElementById('oscConnectBtn');
            const disconnectBtn = document.getElementById('oscDisconnectBtn');
            const connInfo = document.getElementById('oscConnectionInfo');
            const recvInfo = document.getElementById('oscRecvInfo');
            const sendInfo = document.getElementById('oscSendInfo');

            if (!dot || !text) return;

            if (oscConnected) {
                dot.className = 'status-dot enabled';
                const modeNames = {1: 'Receiving', 2: 'Sending', 3: 'Send & Receive'};
                text.textContent = modeNames[oscMode] || 'Connected';
                text.style.color = 'var(--accent-green)';
                if (connectBtn) connectBtn.disabled = true;
                if (disconnectBtn) disconnectBtn.disabled = false;

                // Show connection info from stored config
                if (connInfo && window.oscConfig) {
                    connInfo.style.display = 'block';
                    // Receive info (mode 1 or 3)
                    if (oscMode === 1 || oscMode === 3) {
                        const recvIp = window.oscConfig.recvIp || '0.0.0.0';
                        const recvPort = window.oscConfig.recvPort || 8000;
                        recvInfo.innerHTML = `<strong>Listening:</strong> ${recvIp}:${recvPort}`;
                        recvInfo.style.display = 'block';
                    } else {
                        recvInfo.style.display = 'none';
                    }
                    // Send info (mode 2 or 3)
                    if (oscMode === 2 || oscMode === 3) {
                        const sendIp = window.oscConfig.sendIp || '127.0.0.1';
                        const sendPort = window.oscConfig.sendPort || 9000;
                        sendInfo.innerHTML = `<strong>Sending to:</strong> ${sendIp}:${sendPort}`;
                        sendInfo.style.display = 'block';
                    } else {
                        sendInfo.style.display = 'none';
                    }
                }
            } else {
                dot.className = 'status-dot disconnected';
                text.textContent = 'Disconnected';
                text.style.color = '';
                if (connectBtn) connectBtn.disabled = false;
                if (disconnectBtn) disconnectBtn.disabled = true;
                if (connInfo) connInfo.style.display = 'none';
            }
        }

        // Add OSC log entry
        function addOscLogEntry(entry) {
            const logWindow = document.getElementById('osc-log-window');
            if (!logWindow) return;

            const div = document.createElement('div');
            div.style.marginBottom = '3px';
            div.style.borderBottom = '1px solid rgba(48, 54, 61, 0.5)';
            div.style.paddingBottom = '3px';

            const time = new Date().toLocaleTimeString();
            const timeSpan = `<span style="color: var(--text-secondary);">[${time}]</span>`;

            if (entry.type === 'recv') {
                div.innerHTML = `${timeSpan} <span style="color: var(--accent-blue);">‚óÄ RECV:</span> ${entry.message}`;
            } else if (entry.type === 'send') {
                div.innerHTML = `${timeSpan} <span style="color: var(--accent-green);">‚ñ∂ SEND:</span> ${entry.message}`;
            } else {
                div.innerHTML = `${timeSpan} <span style="color: var(--text-secondary);">${entry.message}</span>`;
            }

            logWindow.appendChild(div);
            logWindow.scrollTop = logWindow.scrollHeight;

            // Limit entries
            while (logWindow.children.length > 100) {
                logWindow.removeChild(logWindow.firstChild);
            }
        }

        // Clear OSC log
        function clearOscLog() {
            const logWindow = document.getElementById('osc-log-window');
            if (logWindow) logWindow.innerHTML = '';
        }

        // Refresh config file list using REST API (more reliable than WebSocket)
        async function refreshConfigList() {
            log('Loading config files list...', 'com');
            try {
                const response = await fetch('/api/configs');
                const data = await response.json();
                if (data.config_files) {
                    updateConfigList(data.config_files);
                } else {
                    log('No config files found', 'wrn');
                }
            } catch (error) {
                console.error('Failed to load config files:', error);
                log('Failed to load config files: ' + error.message, 'err');
            }
        }

        // Update config dropdown with file list
        function updateConfigList(files) {
            const select = document.getElementById('configFileName');
            if (!select) {
                console.error('Config dropdown element not found!');
                return;
            }
            if (!files || !Array.isArray(files)) {
                console.error('Invalid config files data:', files);
                return;
            }

            const currentValue = select.value;

            let html = '<option value="">-- Select Config --</option>';
            files.forEach(file => {
                const selected = file === currentValue ? 'selected' : '';
                html += `<option value="${file}" ${selected}>${file}</option>`;
            });
            select.innerHTML = html;
            log(`Found ${files.length} config files`, 'sys');
        }

        // Load config file
        function loadConfigFile() {
            const fileName = document.getElementById('configFileName').value;
            if (!fileName) {
                log('Please select a config file first', 'err');
                return;
            }
            log(`Loading config: ${fileName}...`, 'com');
            sendCmd('load_config', { filename: fileName });
        }

        // Run template (single execution)
        function runTemplate() {
            // Send the loaded config with the template command
            if (loadedConfig) {
                sendCmd('template', { config: loadedConfig });
                log(`Running template: ${loadedConfig.template?.name || 'Unnamed'} (single run)...`, 'com');
            } else {
                // Fallback: send filename if no config loaded
                const fileName = document.getElementById('configFileName').value || 'config_both.json';
                sendCmd('template', { filename: fileName });
                log(`Running template from ${fileName} (single run)...`, 'com');
            }
        }

        // Run template in loop mode
        function runTemplateLoop() {
            // Send the loaded config with the template command
            if (loadedConfig) {
                sendCmd('template_loop', { config: loadedConfig });
                log(`Running template: ${loadedConfig.template?.name || 'Unnamed'} (LOOP mode - press STOP to end)...`, 'com');
            } else {
                // Fallback: send filename if no config loaded
                const fileName = document.getElementById('configFileName').value || 'config_both.json';
                sendCmd('template_loop', { filename: fileName });
                log(`Running template from ${fileName} (LOOP mode - press STOP to end)...`, 'com');
            }
        }

        // Update PP effective velocity display
        function updatePPEffective() {
            const speed = parseInt(document.getElementById('ppSpeed').value) || 80;
            const velocity = speed * 1000;
            const accelDecel = Math.floor(velocity / 2);
            document.getElementById('ppEffectiveVel').textContent = velocity.toLocaleString();
            document.getElementById('ppEffectiveAccel').textContent = accelDecel.toLocaleString();
        }

        // Update PV effective velocity display
        function updatePVEffective() {
            const speed = parseInt(document.getElementById('pvSpeed').value) || 50;
            const velocity = speed * 1000;
            const accelDecel = Math.floor(velocity / 2);
            document.getElementById('pvEffectiveVel').textContent = velocity.toLocaleString();
            document.getElementById('pvEffectiveAccel').textContent = accelDecel.toLocaleString();
        }

        // Update CSP effective velocity display
        function updateCSPEffective() {
            const maxStep = parseInt(document.getElementById('cspMaxStep').value) || 800;
            document.getElementById('cspEffectiveVel').textContent = (maxStep * 1000).toLocaleString();
        }

        // Apply PP Mode Speed
        function applyPPSpeed() {
            const speed = parseInt(document.getElementById('ppSpeed').value) || 80;
            const velocity = speed * 1000;
            const accelDecel = Math.floor(velocity / 2);

            sendCmd('set_speed', {
                mode: 'PP',
                velocity: velocity,
                acceleration: accelDecel,
                deceleration: accelDecel
            });

            log(`PP Speed: vel=${velocity}, accel/decel=${accelDecel}`, 'com');
        }

        // Apply CSP Mode Speed
        function applyCSPSpeed() {
            const maxStep = parseInt(document.getElementById('cspMaxStep').value);

            sendCmd('set_speed', {
                mode: 'CSP',
                csp_velocity: maxStep
            });

            log(`CSP Speed: max_step=${maxStep} units/ms (${maxStep * 1000} units/s)`, 'com');
        }

        // Apply PV Mode Speed
        function applyPVSpeed() {
            const speed = parseInt(document.getElementById('pvSpeed').value) || 50;
            const velocity = speed * 1000;
            const accelDecel = Math.floor(velocity / 2);

            sendCmd('set_speed', {
                mode: 'PV',
                velocity: velocity,
                acceleration: accelDecel,
                deceleration: accelDecel
            });

            log(`PV Speed: vel=${velocity}, accel/decel=${accelDecel}`, 'com');
        }

        // Logging
        function log(message, type = 'sys') {
            const logWindow = document.getElementById('log-window');
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
            
            const typeLabels = {
                'sys': ['SYS', 'log-sys'],
                'com': ['COM', 'log-com'],
                'wrn': ['WRN', 'log-wrn'],
                'err': ['ERR', 'log-err']
            };
            
            const [label, className] = typeLabels[type] || typeLabels['sys'];
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-ts">${timestamp}</span> <span class="${className}">[${label}]</span> ${message}`;
            
            logWindow.insertBefore(entry, logWindow.firstChild);
            
            while (logWindow.children.length > 100) {
                logWindow.removeChild(logWindow.lastChild);
            }
        }

        // Template log function
        function templateLog(message, type = 'info') {
            const logWindow = document.getElementById('template-log-window');
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
            
            const typeColors = {
                'info': 'var(--text-secondary)',
                'config': 'var(--accent-blue)',
                'step': 'var(--accent-green)',
                'move': 'var(--text-gold)',
                'complete': 'var(--accent-green)',
                'error': 'var(--accent-red)',
                'stop': 'var(--accent-red)'
            };
            
            const color = typeColors[type] || typeColors['info'];
            
            const entry = document.createElement('div');
            entry.style.color = color;
            entry.style.marginBottom = '4px';
            entry.innerHTML = `<span style="color: var(--text-secondary);">${timestamp}</span> ${message}`;
            
            logWindow.appendChild(entry);
            logWindow.scrollTop = logWindow.scrollHeight;
            
            while (logWindow.children.length > 50) {
                logWindow.removeChild(logWindow.firstChild);
            }
        }

        // Clear logs
        function clearLogs() {
            document.getElementById('log-window').innerHTML = '';
            log('Logs cleared', 'sys');
        }
        
        // Clear template logs
        function clearTemplateLogs() {
            document.getElementById('template-log-window').innerHTML = '';
            templateLog('Template log cleared', 'info');
        }

        // Update move order log window with calculation details
        function updateMoveOrderLog(logLines) {
            const logWindow = document.getElementById('move-order-log-window');
            if (!logWindow) return;

            // Clear previous content
            logWindow.innerHTML = '';

            // Add timestamp
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
            const headerEl = document.createElement('div');
            headerEl.style.color = 'var(--text-secondary)';
            headerEl.style.marginBottom = '8px';
            headerEl.textContent = `[${timestamp}]`;
            logWindow.appendChild(headerEl);

            // Process each log line
            logLines.forEach(line => {
                const lineEl = document.createElement('div');

                // Color coding based on content
                if (line.startsWith('===')) {
                    // Header lines
                    lineEl.style.color = 'var(--text-gold)';
                    lineEl.style.fontWeight = 'bold';
                    lineEl.style.marginTop = '5px';
                } else if (line.includes('SPREADING')) {
                    lineEl.style.color = 'var(--accent-green)';
                } else if (line.includes('CONVERGING')) {
                    lineEl.style.color = 'var(--accent-blue)';
                } else if (line.includes('LEFT')) {
                    lineEl.style.color = 'var(--accent-red)';
                } else if (line.includes('RIGHT')) {
                    lineEl.style.color = 'var(--accent-green)';
                } else if (line.includes('STATIONARY')) {
                    lineEl.style.color = 'var(--text-secondary)';
                } else if (line.includes('before')) {
                    lineEl.style.color = 'var(--accent-purple)';
                } else if (line.includes('Pick slave')) {
                    lineEl.style.color = 'var(--accent-blue)';
                } else if (line.includes('FINAL ORDER')) {
                    lineEl.style.color = 'var(--text-gold)';
                    lineEl.style.fontWeight = 'bold';
                    lineEl.style.fontSize = '1.1em';
                } else if (line.includes('WARNING')) {
                    lineEl.style.color = 'var(--accent-red)';
                    lineEl.style.fontWeight = 'bold';
                }

                lineEl.textContent = line;
                logWindow.appendChild(lineEl);
            });

            // Scroll to bottom
            logWindow.scrollTop = logWindow.scrollHeight;
        }

        // Clear move order log
        function clearMoveOrderLog() {
            const logWindow = document.getElementById('move-order-log-window');
            if (logWindow) {
                logWindow.innerHTML = '<span style="color: var(--text-secondary);">Move order details will appear here during template execution...</span>';
            }
        }

        // UDP log function
        function addUdpLogEntry(entry) {
            const logWindow = document.getElementById('udp-log-window');
            if (!logWindow) return;

            const timestamp = new Date(entry.time * 1000).toLocaleTimeString('en-US', { hour12: false });

            // Color based on type
            const typeColors = {
                'recv': 'var(--accent-blue)',      // Received message - blue
                'move': 'var(--accent-green)',     // Movement applied - green
                'error': 'var(--accent-red)',      // Error - red
                'info': 'var(--text-secondary)'    // Info - gray
            };

            const color = typeColors[entry.type] || typeColors['info'];

            // Format message
            let displayMsg = entry.message;

            const logEntry = document.createElement('div');
            logEntry.style.color = color;
            logEntry.style.marginBottom = '3px';
            logEntry.style.borderBottom = '1px solid var(--border-ui)';
            logEntry.style.paddingBottom = '3px';
            logEntry.innerHTML = `<span style="color: var(--text-secondary);">${timestamp}</span> ${displayMsg}`;

            // Add to top (newest first)
            logWindow.insertBefore(logEntry, logWindow.firstChild);

            // Keep only last 100 entries
            while (logWindow.children.length > 100) {
                logWindow.removeChild(logWindow.lastChild);
            }
        }

        // Clear UDP logs
        function clearUdpLog() {
            const logWindow = document.getElementById('udp-log-window');
            if (logWindow) {
                logWindow.innerHTML = '';
            }
        }

        // Initialize
        window.onload = () => {
            log('UI initialized', 'sys');
            connectWS();
        };
    </script>
</body>
</html>